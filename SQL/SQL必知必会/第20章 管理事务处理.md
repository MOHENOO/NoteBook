# 管理事务处理

## 事务处理

事务处理是一种机制,用来管理必须成批执行的SQL操作,保证数据库不包含不完整的操作结果.利用事务处理可以保证一组操作不会中途停止,它们要么完全执行,要么完全不执行(除非明确指示).如果没要错误发生,整组语句提交给(写到)数据库表;如果发生错误,则进行回退(撤销),将数据库恢复到某个已知且安全的状态.

- 事务(transaction)指一组SQL语句;
- 回退(rollback)指撤销指定SQL语句的过程;
- 提交(commit)指将未存储的SQL语句结果写入数据库表;
- 保留点(savepoint)指事务处理中设置的临时占位符(placeholder),可以对它发布回退(与回退整个事务处理不同).

**可以回退哪些语句**:事务处理用来管理INSERT,UPDATE和DELETE语句.不能回退SELECT语句(回退SELECT语句也没有必要),也不能回退CREATE或DROP操作.事务处理中可以使用这些语句,但进行回退时,这些操作也不撤销.

## 控制事务处理

**事务处理实现的差异**:不同DBMS用来实现事务处理的语法有所不同.在使用事务处理时请参阅相应的DBMS文档.

管理事务的关键在于将SQL语句组分解成逻辑块,并明确规定数据何时应该回退,何时不应该回退.

有的DBMS要求明确标识事务处理块的开始和结束.

MySQL中使用START TRANSACTION.多数DBMS没有明确标识事务处理在何处结束.事务一直存在,直到被中断.通常,COMMITT用于保存更改,ROLLBACK用于撤销.

### 使用ROLLBACK

SQL的ROLLBACK命令用来回退(撤销)SQL语句.

### 使用COMMIT

一般的SQL语句都是针对数据库表直接执行和编写的.这就是所谓的隐式提交,即提交操作是自动进行的.

在事务处理块中,提交不会隐式进行.不过,不同DBMS的做法有所不同.有的DBMS按隐式提交处理事务端,有的则不这样.

进行明确的提交,使用COMMIT语句.

### 使用保留点

使用简单的ROLLBACK和COMMIT语句,就可以写入或撤销整个事务.但是,只对简单的事务才能这样,复杂的事务可能需要部分提交或回退.

要支持回退部分事务,必须在事务处理块中的合适位置放置占位符.这样如果需要回退,可以回退到某个占位符.
在MySQL,Oracle和MariaDB中创建占位符,可使用SAVEPOINT语句.

每个保留点都要取能够标识它的唯一名字,以便在回退时,DBMS知道回退到何处.

在MySQL,MariaDB和Oracle中,使用ROLLBACK TO {保留点名字} 子句回退.

**保留点越多越好**:可以在SQL代码中设置任意多的保留点,越多越好.保留点越多,就能越灵活地进行回退.