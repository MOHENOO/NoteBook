# 使用存储过程

## 存储过程

迄今为止,我们使用大多数的SQL语句都是针对一个或多个表的单条语句.并非所有操作都这么简单,经常会有一些复杂的操作需要多条语句才能完成.这是可以使用存储过程.简单来说,存储过程就是为以后使用而保存的一条或多条SQL语句.可将其视为批文件,虽然它们的作用不仅限于批处理.

**具体DBMS支持**:Access和SQLite不支持存储过程.MySQL 5已经支持存储过程.

## 为什么要用存储过程

- 通过把处理封装在一个易用的单元中,可以简化复杂的操作.
- 由于不要去反复建立一系列处理步骤,因而保证了数据的一致性.如果所有开发人员和应用程序都使用同一存储过程,则所使用的代码都是相同.这一点的延伸就是防止错误.需要执行的步骤越多,出错的可能性就越大.防止错误保证了数据的一致性.
- 简化对变动的管理.如果表名,列名或业务逻辑有变化.那么只需要更改存储过程的代码.使用它的人员甚至都不需要知道这些变化.这一点的延伸就是安全性.通过存储过程限制对基础数据的访问,减少了无意间数据改动的机会.
- 因为存储过程通常以编译过的形式存储,所以DBMS处理命令所需的工作量较少,提高了性能.
- 存在一些只能用在单个请求中的SQL元素和特性,存储过程可以使用它们来编写功能更强更灵活的代码.

换句话来说,使用存储过程有三个主要的好处,即简单,安全,高性能.虽然,它们都很重要.不过,在将SQL代码转换为存储过程前,也必须知道它的一些缺陷.

- 不同DBMS中的存储过程语法有所不同.事实上,编写真正的可移植存储过程几何不可能的.不过存储过程的自我调用(名字以及数据如何传递)可以相对保持可移植性.因此,如果需要移植到别的DBMS,至少客户端应用代码不需要变动.
- 一般来说,编写存储过程必编写基本SQL语句复杂,需要更高的技能,更丰富的经验.因此,许多数据库管理员把限制存储过程的创建 作为安全措施(主要受上一条缺陷的影响).

尽管有这些缺陷,存储过程还是非常有用的,并且应该使用.事实上,许多DBMS都带有用于管理数据库和表的各种存储过程.

## 执行存储过程

存储过程的执行远比编写要复杂的多.执行存储过程的SQL语句很简单,即EXECUTE.EXECUTE接收存储过程名和需要传递给它的任何参数.

```sql
EXECUTE AddNewP
roduct('JTS01','Stuffed Eiffel Tower',6.49);
```

参数匹配存储过程中预期变量(定义为存储过程自身的组成部分).

对于具体的DBMS,可能包括以下的执行选择:

- 参数可选,具有不提供参数时的默认值;
- 不按次序给出参数,以“参数=值”的方式给出参数.
- 输出参数,允许存储过程在执行的应用程序中更新所用的参数.
- 用SELECT语句检索数据.
- 返回代码,允许存储过程返回一个值到正在执行的应用程序.

## 创建存储过程

Oracle版本:

```sql
CREATE PROCEDURE
MailingListCount(
    ListCount OUT
    INTEGER
)
IS
v_rows INTEGER;
BEGIN
    SELECT COUNT(*)
    INTO v_rows
    FROM Customers
    WHERE NOT cust_email IS NULL;
    ListCount :=v_rows;
END;
```

这个存储过程有一个名为ListCount的参数.此参数从存储过程返回一个值而不是传递一个值给存储过程.关键字OUT用来指示这种行为.Oracle提供IN(传递值给存储过程),OUT(从存储过程返回值),INOUT(既传递值给存储过程也从存储过程传回值)类型的参数.存储过程的代码括在BEGIN和END语句中,这里执行一条简单的SELECT语句,然后用检索出的行数设置ListCount(要传递的输出参数).