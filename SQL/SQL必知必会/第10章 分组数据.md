# 分组数据

## 数据分组

使用分组可以将数据分为多个逻辑组,对每个组进行聚集计算.

## 创建分组

分组是使用SELECT语句的GROUP BY 子句建立的.GROUP 子句指示DBMS分组数据,然后对每个组而不是整个结果集进行聚集.

在使用GROUP BY子句前,需要知道一些重要的规定.

- GROUP BY子句可以包含任意数目的列,因而可以对分组进行嵌套,更细致地进行数据分组.
- 如果在GROUP BY子句中嵌套了分组,数据将在最后指定的分组上进行汇总.换句话说,在建立分组时,指定的所有列一起计算(所以不能从个别的列取回数据).
- GROUP BY子句中列出的每个列都必须是检索列或有效的表达式(但不能是聚集函数).如果在SELECT中使用表达式,则必须在GROUP BY子句中指定相同的表达式.不能使用别名.
- 大多数SQL实现不允许GROUP BY列带有长度可变的数据类型(如文本或备注型字段).
- 除聚集计算语句外,SELECT语句的每一列必须在GROUP BY子句中给出.
- 如果分组列中包含具有NULL的行,则NULL将作为一个分组返回.如果列中有多行NULL值,它们将分为一组.
- GROUP BY子句必须出现在WHERE子句之后,ORDER BY子句之前.

**ALL子句**:Microsoft SQL Server等有些SQL实现在GROUP BY中支持可选的ALL子句.这个子句可用来返回所有分组,即使是没有匹配行的分组也返回(在此情况下,聚集将返回NULL).具体的DBMS是否支持ALL,请参阅相应的文档.

## 过滤分组

除了能用GROUP BY分组数据外,SQL还允许过滤分组,规定包括哪些分组,排除哪些分组.SQL为此提供了另一个子句,HAVING子句.HAVING非常类似于WHERE.事实上,目前所有学过的WHERE子句都可以用HAVING来替代.唯一的差别时,WHERE过滤行,而HAVING过滤分组.

```sql
SELECT cust_id,COUNT(*)
AS orders
FROM Orders
GROUP BY cust_id
HAVING COUNT(*)>=2;
```

过滤是基于分组聚集值,而不是特定行的值.

**HAVING和WHERE的差别**:WHERE在数据分组前进行过滤,HAVING在数据分组后进行过滤.在不指定GROUP BY子句的情况下,大多数DBMS会同等对待它们.不够你自己要能区分这一点.使用HAVING应该结合GROUP BY子句.而WHERE子句用于标准的行级过滤.

## 分组和排序

|                  ORDER BY                  |                       GROUP BY                        |
| :----------------------------------------: | :---------------------------------------------------: |
|              对产生的输出排序              |           对行分组,但输出可能不是分组的顺序           |
| 任何列都可以使用(甚至非选择的列也可以使用) | 只能使用选择列或表达式列,而且必须使用每个选择列表达式 |
|                 不一定需要                 |     如果与聚集函数一起使用列(或表达式),则必须使用     |

**不要忘记ORDER BY**:一般在使用GROUP BY子句时,应该也给出ORDER BY子句.这是保证数据正确排序的唯一方法.千万不要仅依赖GROUP BY排序数据.

## SELECT子句顺序

|   子句   |        说明        |       是否必须使用       |
| :------: | :----------------: | :----------------------: |
|  SELECT  | 要返回的列或表达式 |            是            |
|   FROM   |  从中检索数据的表  | 仅在从表中选择数据时使用 |
|  WHERE   |      行级过滤      |            否            |
| GROUP BY |      分组说明      |  仅在按组计算聚集时使用  |
|  HAVING  |      组级过滤      |            否            |
| ORDER BY |    输出排序顺序    |            否            |