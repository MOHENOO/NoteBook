# 高级SQL特性

## 约束

关系数据库存储分解为多个表的数据,每个存储相应的数据.利用键来建立从一个表到另一个表的引用.
正确地进行关系数据库设计,需要一种方法保证只在表中插入合法数据.虽然可以在插入新行时进行检查,但最好不要这样做:

- 如果在客户端层面上实施数据库完整性规则,则每个客户端都要被迫实施这些规则,一定会有一些客户端不实施这些规则.
- 在执行UPDATE和DELETE操作时,也必须实施这些规则.
- 执行客户端检查是非常耗时的,而DBMS执行这些检查会相对高效.

**约束**:管理如何插入或处理数据库的规则.

DBMS通过在数据库上施加约束来实施引用完整性.

### 主键

主键是一种特殊的约束,用来保证一列(或一组列)中的值是唯一的,而且永不改动.换句话说,表中的一列(或多个列)的值唯一标识表中的每一行.

表中任意列只要满足以下条件,都可以用于主键:

- 任意两行的主键值都不相同.
- 每行都具有一个主键值(即列中不允许NULL值).
- 包含主键值的列从不修改或更新.(大多数DBMS不允许这么做,但如果你是用的DBMS允许这样做,也千万不要这样做).
- 主键值不能重用.如果从表中删除某一行,其主键值不分配给新行.

主键的定义有两种方法,一种是创建表时通过PRIMARY KEY标识它.另一种是使用CONSTRAINT语法.此语法也可以用于CREATE TABLE和ALTER TABLE语句.

**SQLite中的键**:SQLite不允许使用ALTER TABLE定义键,要求在初始的CREATE TABLE语句中定义它们.

### 外键

外键是表中的一列,其值必须列在另一个表的主键中.外键是保证引用完整性的极其重要部分.外键可以使用REFERENCES关键字,也可以在ALTER TABLE语句中用CONSTRAINT语法.

**外键有助防止意外删除**:在定义外键后,DBMS不允许删除在另一个表中具有关联行的行.因而利用外键可以防止意外删除数据.

有的DBMS支持称为级联删除的特性.如果启用,该特性在从一个表中删除行时删除所有相关的数据.

### 唯一约束

唯一约束用来保证一列(或一组列)中的数据是唯一的.它们类似于主键,但存在以下重要区别:

- 表中可以包含多个唯一约束,但每个表只允许一个主键.
- 唯一约束列可包含NULL值.
- 唯一约束列可修改或更新.
- 唯一约束列的值可重复使用.
- 与主键不一样,唯一约束不能用来定义外键.

唯一约束可以用UNIQUE关键字在表定义中使用,也可以用单独的CONSTAINT定义.

### 检查约束

检查约束用来保证一列(或一组列)中的数据满足一组指定的条件.建冲约束的常用用途有:

- 检查最小或最大值
- 指定范围
- 只允许特定的值

可通过创建表时CHECK()来添加,也可以用ADD CONSTRAINT CHECK添加.

**用户定义数据类型**:有的DBMS允许用户定义自己的数据类型.它们是定义检查约束(或其他约束)的基本简单数据类型.定义数据类型的优点是只需施加约束一次(在数据类型定义中),而每当使用该数据类型时,都会自动引用这些约束.

## 索引

索引用来排序数据以加快搜索和排序操作的速度.使索引有用的因素是恰当的排序.数据库中主键数据总是排序的,这是DBMS的工作.因此,按主键检索特定行中式一种快速有效的操作.

但是,搜索其他列中的值通常效率不高.解决办法时使用索引.可以在一个或多个列上定义索引,使DBMS保存器内容的一个排过序的列表.

创建索引前,需要记住以下内容:

- 索引改善检索操作的性能,但降低了数据插入,修改和删除的性能.在执行这些操作时,DBMS必须动态地更新索引.
- 索引可能需要占用大量的存储空间.
- 并非所有数据都适合做索引.取值不多的数据不如具有更多可能值的数据,能通过索引得到那么多好处.
- 索引用于数据过滤和数据排序.如果你经常以某种特定的顺序排序数据,在该数据可能适合做索引.
- 可以在索引中定义多个列.这样的索引仅在定义列顺序排序时有用.

索引用CREATE INDEC语句创建.

```sql
CREATE INDEX prod_name_ind
ON Products(prod_name);
```

索引必须唯一命名.

**检索索引**:索引的效率随表数据的增加或改变而变化.最好定期检查索引,并根据需要对索引进行调整.

## 触发器

触发器是特殊的存储过程,它在特定的数据库活动发生时自动执行.触发器可以与特定表中的INSERT,UPDATE和DELETE操作(或组合)相关联.

不一样与存储过程不一样(存储过程只是简单的存储SQL语句),触发器与单个的表相关联.触发器内的代码具有以下数据的访问权:

- INSERT操作中的所有新数据
- UPDATE操作中的所有新数据和旧数据;
- DELETE操作中删除的数据.

根据所使用的DBMS的不同,触发器可在特定操作执行之前或之后执行.

触发器的常见用途:

- 保证数据一致.
- 基于某个表的变动在其他表上执行活动.
- 进行额外的验证并根据需要回退数据
- 计算计算列的值或更新时间戳

**约束比触发器更快**:一般来说,约束的处理比触发器快,因此在可能的时候,应该尽量使用约束.

## 数据库安全

- 对数据库管理(创建表,更改表或删除已存在的表等)的访问;
- 对特定数据库或表的访问;
- 访问的类型(只读,对特定列的访问等);
- 仅通过视图或存储过程对表进行访问;
- 创建多层次的安全措施,从而允许多种基于登陆的访问和控制;
- 限制管理用户账户的能力.

安全性使用SQL的GRANT和REVOKE语句来管理.不过大多数DBMS提供了交互式的管理使用程序.